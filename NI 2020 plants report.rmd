---
title: "Vascular plant indicators for the Nature Index 2020"
author: Olav Skarpaas
output: word_document
---

```{r setup, include=FALSE, label="Setup"}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
```


```{r results='asis', echo=FALSE, include=FALSE, label="Loading libraries and data objects"}
# Load libraries and data objects for prediction and plotting of results
library(knitr)        # Report generating tools
library(kableExtra)   # Table tools
library(mgcv)         # GAM methods
library(raster)       # Raster methods
library(rgdal)        # Geoprocessing tools
library(fields)       # Image processing and colours
library(adehabitatHR) # Minimum convex polygons
if(!exists("gam.results")) load("Results/gam.results.all.gamma3")
if(!exists("NIGAM_All.list")) load("Results/NIGAM_All.list")
if(!exists("norway")) norway <- raster("Data/Raster/Norway.tif")
```


# 1. Introduction

This report describes the methods and results for estimation of indicator values for a set of vascular plant species indicators in the Nature Index (NI) for Norway 2020 (Table 1). These indicators are based on occurrence data available through the Global Biodiversity Information Facility (www.gbif.org; mirrored in the Norwegian Biodiversity Information Centre portal Artskart, artskart.artsdatabanken.no). For the last major update of NI in 2015, the states of these indicators were modelled across space and time using a hierarchical and dynamical spatiotemporal model (based on Wikle 2003; Wikle & Hooten 2010) This model had the advantage of accounting for noise in the observation process as well as capturing population developments through time by incorporating dependence on the previous states of the local and neighboring populations. These advantages came with a high computational cost. The analyses required methods that allow little experimentation (Bayesian MCMC) and low spatial resolution (100km by 100km). The coarse resolution potentially introduces prediction error (imprecision and bias) and also raises the issue of how well the observations of the indicators represent populations in the major ecosystem that they are supposed to represent in the Nature Index (woodland, mountain, open lowland and wetland) and how indicator observations and predictions relate to pressures. Therefore, the vascular plant indicators for NI 2020 were estimated with computationally less demanding methods, providing estimates with higher spatial resolution and higher precision. The main aim of this report is to document the estimation process, to make it fully reproducible, and to investigate indicator-ecosystem relations and effects of pressures.

The report is structured as follows. Section 2 describes the data and gives a brief assessment of the relationship between indicator species occurrences and land cover types (as a proxy for major ecosystems). Section 3 describes the methods for estimation of indicator states, including the reference state, and discusses some key aspects of these results. Section 4 gives an assessment of relationships between indicator trends and pressures. Finally, Section 5 presents some perspectives on methods and results, and summarizes the main conclusions. Additional information (R scripts and results) is provided in appendices.  
  
  
  
```{r echo=FALSE, results='asis'}
load("myIndicators")
ind <- myIndicators
names(ind) <- c("ID","NI indicator name","Scientific name")
species <- ind$`Scientific name`
kable(ind,format="markdown",row.names=FALSE,
      caption="Table 1. Indicator species for the Nature Index (NI) of Norway covered in this report, with indicator ID number in the NI database, indicator name in the NI database (Norwegian species name) and scientific name.")
```
  


# 2. Data
## Species occurrences and environmental covariates
Species occurrence data were downloaded from GBIF (see Appendix 1). Occurrences were counted within each 1km by 1km cell in five-year intervals. The total number of unique visits (i.e. the number of dates with records of one or more vascular plants within a cell over the five-year interval) was used as an offset to correct for sampling effort (see details on modelling below).  

Environmental data were taken from Horvath et al. (2019), including landcover, climate, etc., aggregated to 1km resolution. These data were supplemented with nitrogen deposition data from Lund et al. (2012) at the municipal level. Note that none of these environmental data were used to estimate the state of indicators; they were only used to explore properties of the occurrence data in relation to land cover (next section) and to assess estimated trends in relation to environmental conditions and pressures (below).

## Land cover affinity
To get an indication of the "representativeness" of the indicators for their major ecosystems, species records (with coordinates) of each species were summarized by dominant land cover type in in 1km by 1km cells (Table 2). As expeced, the woodland indicators (_Ulmus glabra_, _Primula vulgaris_, _Moneses uniflora_) are frequently found in forest-dominated areas, and the mountain indicators (_Papaver radicatum_, _Kalmia procumbens_, _Ranunculus glacialis_) have high frequencies in areas dominated by barren land. _Ranunculus glacialis_ and _Kalmia procumbens_ are the only species with records in areas dominated by glaciers. Two of the indicators of open lowland, _Leucanthemum vulgare_ and _Arnica montana_, are most frequently found in forest-dominated areas, while the third, _Erica cinerea_, is most often found in areas dominated by barren land. This reflects the ecology of the species: the two former species are associated with areas of extensive agriculture (pastures and hayfields), often found in areas dominated by forest and nowadays often in succession towards forest, while the latter is found in the coastal heathlands in between rocky areas with shallow soil. Finally, the wetland indicators (_Thelypteris palustris_, _Carex vesicaria_, _Carex pauciflora_, _Dactylorhiza incarnata_, _Rhynchospora alba_, _Rhynchospora fusca_, _Drosera anglica_ and _Drosera intermedia_) have higher frequencies in mires than most other species, but are still most frequent in forest-dominated areas, where many small mires are found.  
  
To summarize, the occurrences of the indicator species are more or less as expected with respect to dominant land cover at the scale of 1km by 1km. However, the dominant land cover at this spatial scale is not a good representation of the main ecosystem of open lowland and wetland species, as many habitats of these species are found in areas dominated by other land cover types (often forest).  
  
  
```{r echo=FALSE}
# Summarize observations of species across landcover types
selected.years <- c(1980,1990,2000,2010)
artable <- matrix(NA,nrow=length(species),ncol=8) # number of land cover classes: 8
for(i in 1:length(species))
{
  # Training data for species from GBIF, see NI 2020 plants dataprep.r
  load(paste("Data/Regression data/",species[i],"_training_data",sep=""))
  d <- training_data
  d <- d[d$year%in%selected.years,]  # selected years only
  artable[i,] <- tapply(d$Y,d$ar50artype,sum)
  artable[i,] <- 100*artable[i,]/sum(artable[i,]) # Expressing records in percent
}
rownames(artable) <- species
colnames(artable) <- c("Developed","Agricultural","Forest","Barren","Mire","Glacier","Freshwater","Marine")
# Colnames are short names for the following AR50 land cover classes:
# 10	Developed area. Residential area, town center, city, transport, industrial area and alike.
# 20	Agricultural area. Cropland, cultivated soil and cultivated pastures
# 30	Forest. Afforested area
# 50	Barren land. Land areas with natural vegetation cover that is not forest.
# 60	Bog and Fen. Land areas with characteristics of marshes
# 70	Glacier. Ice and snow that does not melt during the summer.
# 81	Freshwater. Rivers and lakes
# 82	Ocean.
# 99	Not mapped.

kable(round(artable,1),format="markdown",caption="Table 2. Percent of records in 1km by 1km cells with a given dominant land cover type for each of the indicator species.")
#%>%
#kable_styling("striped", full_width = F) %>%
#  row_spec(0, angle = -90)
```
  
# 3. Modelling indicator values

## A generalized additive space-time model
To model the distribution of the indicator species in space and time we used Generalized Additive Models (GAM; Wood 2017). These models are flexible enough to capture complex non-linear patterns in space and time, while at the same time being computationally efficient and accessible through the extensive R package 'mgcv'. This means (among others) that the analyses can be carried out with relatively high resolution without resorting to specialized software and supercomputing resources.

The response variable in the model is the count of observations of a species within 1km by 1km cells in a five-year interval, with a Poisson error distribution. To account for sampling effort, the total count of unique visits to each cell in the same time interval (as defined above) was included as an offset variable on the log scale. When the sampling effort is 1, the model is essentially a model of the rate of occurrence of the species in a sample from a cell. This is useful when making predictions from the model: we can then set the sampling effort to S = 1 (or log S = 0).

The only covariates in the models are spatial and temporal coordinates (x, y and year). Although other environmental variables clearly affect the species, the aim here is to estimate the state of the indicators in space and time - without the need for additional information (which may not be available at times and places where we might want to predict the state of the indicator). Assessment of relationships between estimated states of indicators and environmental pressures are carried out in a second step (below). 

The model specification in 'gam' looks like this:
```{r eval=FALSE, echo=TRUE}
gam(Y ~ ti(x) + ti(y) + ti(year) + ti(x,year) + ti(y,year), family=poisson, offset=logS, data=d, gamma=3, select=TRUE)
```
where Y is the count of the species in five-year intervals, x and y are the spatial coordinates, time is represented by the first year of the time interval and logS is the natural logarithm of the sampling effort (unique visits) S in the time interval. These variables are all contained in the data set d (see Appendix 1). The model was fit to all available data for each species 1820-2019: to maximize data back in time no filtering on spatial precision was applied (in contrast to the assessment of land cover relations above). This is needed to estimate the reference state (initial attempts at filtering the data on precision lead to highly uncertainty backwards in time, and unrealistic trends in space and time). Low accuracy of observations may be less of a problem here than in many other applications: The resolution of NI is municipalities, which corresponds to the precision of some of the older occurrence data. Nevertheless, to reduce sensitivity to artificial patterns in the data, three-way interactions between spatial coordinates (x,y) and time (year) in the tensor smoothing functions ti() were omitted, and the smoothing parameter gamma was set to three (more smoothing than default).
  
The R code for estimation of the indicator values, including data download and export of estimates to the NI database, is given in Appendix 1.  


## Estimates of indicator values
The models suggest that there are spatiotemporal patterns in all species (see model summaries in Appendix 2). The models reproduced relatively complex well-known patterns in the distributions of the species. For instance, for the alpine herb _Ranunculus glacialis_ the model predicts the bimodal distribution of the species in the southern and northern mountain massifs of Norway, as a result of bimodal response curves from west to east and south to north (Figure 1, left panels). For the lowland herb _Arnica montana_, the model predicts higher probability of occurrence towards the east and south, as a combined result of a unimodal response to the west-east gradient and a declining curve towards the north (Figure 1, right panels). Note that south-north and west-east patterns cannot be interpreted completely independently, as the northernmost areas of Norway are also furthest to the east. In the case of _Arnica montana_ this results in higher prediction uncertainty towards the east and north, because the species is found in the southeast of the country, but not in the northeast. Unclear trends along individual spatial axes occur in several of the indicator species with more complex or limited distribution patterns, especially when moving (far) outside the known distribution of the species. However, in the Nature Index, these predictions are filtered away: only predictions within the known distribution (the definition area; see www.naturindeks.no) are used to calculate the index.

```{r echo=FALSE}
# Calculating minimum convex polygons of observations (~definition area polygons); used to filter predictions
mcpoly <- list()
# pdf("Minimum convex polygons.pdf")
for(i in 1:length(species))
{
  # Training data for species from GBIF, see NI 2020 plants dataprep.r
  load(paste("Data/Regression data/",species[i],"_training_data",sep=""))
  d <- training_data
  xypoints <- SpatialPoints(training_data[d$presence==1,c("x","y")])
  mcpoly[[i]] <- mcp(xypoints,percent=99)
  # plot(norway,main=species[i])
  # points(xypoints,pch=".")
  # plot(mcpoly[[i]],add=TRUE)
}
# dev.off()
mcras <- list()
for(i in 1:length(species))
{
  mcras[[i]] <- rasterize(mcpoly[[i]],norway)
}
```

```{r echo=FALSE, fig.width=8, fig.height=10}
#par(mfrow=c(2,2),oma=c(0,0,3,0))
def.par <- par(no.readonly = TRUE) # save default, for resetting...
layout(matrix(c(1,4,1,4,2,5,3,6), 4, 2, byrow = TRUE))
year <- c(1900,1950,1990,2000,2010,2014,2019)
i <- 4
for(j in c(4,11))
{
  #p.poly <- NIGAM_All.list[[j]][[i]]$p # plot selected species j and year i
  p.poly <- readOGR(dsn="Results",layer=paste(species[j],year[i]),verbose=FALSE,encoding="") # map of selected species j and year i
  b <- pretty(c(0,max(p.poly$layer,na.rm=T)),n=8)
  n <- length(b)
  pcut <- cut(p.poly$layer,breaks=b)
  pcol <- rev(terrain.colors(n-1))
  plot(p.poly,col=pcol[pcut],main=species[j])
  legend("bottomright",legend=rev(levels(pcut)),fill=rev(pcol),bty="n",title=paste("Probability of obs\nper 1x1km",year[i]))
  plot(gam.results[[j]],select=1,scale=0,shade=TRUE,seWithMean=TRUE)
  plot(gam.results[[j]],select=2,scale=0,shade=TRUE,seWithMean=TRUE)
}
#mtext(species[1],outer=TRUE)
par(def.par)
```
  
_Figure 1. Maps showing the estimated states of two indicator species in the year 2000. For each species the main effects of spatial coordinates west-east (x) and south-north (y) are plotted underneeth the map (tensor smooth, with estimated degrees of freedom) with confidence intervals (shaded areas)._



The models suggest that most species do not have strong overall temporal trends, but that there is spatial variability in the trends (Figure 2). Some of this is as expected; see the discussion of species distribution and trends in relation to climate and pressures below. However, there are also some results that contradict expectations, at least at first glance. For instance, for _Ulmus glabra_, the model estimates an overall positive trend with time. In the latest national Red list for species in Norway (Henriksen & Hilmo 2015), _Ulmus glabra_ is listed as vulnerable (VU) because of elm disease, browsing and competition with introduced trees. This may have caused population declines, at least locally, and may cause larger declines in the future. However, this negative trend is not apparent in the analyses of this study. Regardless of choice of reference time within the modeled time span, _Ulmus glabra_ has a positive development in recent times. This may be because the reported declines are only local.


```{r echo=FALSE, fig.width=8, fig.height=12}
#par(mfrow=c(2,2),oma=c(0,0,3,0))
# Load libraries and data objects for prediction and plotting of results
def.par <- par(no.readonly = TRUE) # save default, for resetting
layout(matrix(c(1,3,1,3,2,4,5,7,5,7,6,8), 6, 2, byrow = TRUE))
for(j in c(4,11,6,1))
{
  p.poly <- NIGAM_All.list[[j]][[2]]$p
  p.poly2 <- NIGAM_All.list[[j]][[7]]$p
  p.poly$layer <- p.poly2$layer-p.poly$layer
  #b <- 2^seq(-10,10)
  #b <- seq(-0.1,0.1,by=0.02)
  r <- max(abs(range(p.poly$layer,na.rm=T)))
  b <- pretty(c(-r,r),n=8)
  n <- length(b)
  pcut <- cut(p.poly$layer,breaks=b)
  pcol <- rev(tim.colors(n-1))
  plot(p.poly,col=pcol[pcut],main=species[j])
  legend("bottomright",legend=rev(levels(pcut)),fill=rev(pcol),bty="n",title=paste("Trend",year[2],"-",year[7]))
  plot(gam.results[[j]],select=3,scale=0,shade=TRUE,seWithMean=TRUE)
  # plot(gam.results[[j]],select=5,scheme=2,scale=0,shade=TRUE,seWithMean=TRUE,main=species[j])
}
par(def.par)
```
  
_Figure 2. Maps showing the difference in predicted indicator values between 1950 and 2019 for four selected indicator species. For each species the main effect of time (year) across the entire time period of the data is plotted underneeth the map (tensor smooth, with estimated degrees of freedom). Note that in some cases the map predictions are (far) outside the range of the species (e.g. _Arnica montana_, _Thelypteris palustris_ and _Ulmus glabra_ in Northern Norway), and that such predictions are filtered away when calculating the Nature Index._
  

# 4. Assessing trends and pressures
This section considers a (limited) selection of pressures in relation to estimated trends (model predictions) in the state of the indicator species from 1950 to 2019. The results are based on comparisons of predicted trends across the entire grid within the convex polygon covering 99% of the observations of the species. The number of cells with predictions within these areas are still much larger than the number of cells with observational data. The relationships between trends and pressures are therefore not tested statistically (the degrees of freedom are strongly inflated).

 
```{r echo=FALSE}
xy <- coordinates(norway)
x <- y <- norway
values(x) <- xy[,1]
values(y) <- xy[,2]
year <- c(1900,1950,1990,2000,2010,2014,2019)
trend <- list()
pred.ras <- stack(norway,x,y,log(norway))
names(pred.ras)[1:4] <- c("year","x","y","logS")
pred.dat <- as.data.frame(values(pred.ras))
p <- norway
for(j in 1:length(species))
{
  pred.dat$year <- year[2]
  pred1 <- predict(gam.results[[j]],pred.dat,type="response") # The ordinary raster prediction does not always work: p <- predict(pred.ras,glm.results[[1]],type="response")
  pred.dat$year <- year[7]
  pred2 <- predict(gam.results[[j]],pred.dat,type="response") # The ordinary raster prediction does not always work: p <- predict(pred.ras,glm.results[[1]],type="response")
  values(p) <- as.vector(pred2)-as.vector(pred1)
  trend[[j]] <- p*norway # filtering away predictions outside the mainland
}
names(trend) <- species

```

 
```{r echo=FALSE}
# Make environmental covariate raster stack and data frame
r.list <- list.files("Data/Raster/Predictors", pattern="tif$", full.names=TRUE) # add all raster files in a given folder to a list (modify path as appropriate)
predictors <- stack(r.list)                                                     # read and stack raster layers
names(predictors) <- sub("_1km","",names(predictors))
names(predictors) <- gsub("_","",names(predictors))
pred.dat <- as.data.frame(values(predictors))
```

There were no strong patterns in trends with dominant land cover (Table 3). A few possible patterns may still be worth a note. Four species had consistently positive mean trends for all land cover classes (_Ulmus glabra_, _Kalmia procumbens_, _Primula vulgaris_ and _Drosera anglica_), and three species had consistently negative mean trends (_Thelypteris palustris_, _Carex vesicaria_ and _Rhynchospora alba_). For the other ten species, the mean estimated trends varied across landcover types, but with relatively small amounts and high variability (not shown). Several species (e.g. _Moneses uniflora_, _Arnica montana_, _Carex pauciflora_ and _Rhynchospora alba_) had low mean trends in developed and agricultural areas compared to areas dominated by other land cover types. This could be a random pattern (the variability is high), but may perhaps also reflect better performance of these species in areas with less intense human activity. There are also a few patterns that may reflect climate rather than land cover: _Ulmus glabra_ has the strongest growth in areas dominated by glaciers and _Primula vulgaris_ in marine areas (coast), which may be related to temperature and precipitation respectively. _Papaver radicatum_ had the lowest growth rates in areas dominated by barren lands and glaciers. This may be related to better growing conditions for competitors in these areas due to increasing temperatures and/or less snow cover.
  
  

```{r echo=FALSE}
# # Boxplots of all species
# pdf("boxplots.pdf")
# for(i in 1:length(species))
# {
#   tr <- values(trend[[i]]*mcras[[i]])
#   dat <- data.frame(ar=pred.dat$ar50artype,tr=tr)
#   boxplot(tr~ar,data=dat,xlab="Land cover class",main=species[i],ylim=range(c(0,tr),na.rm=T))
#   abline(h=0,lty=3)
#   print(table(dat$ar))
# }
# dev.off()

# Table for all species
arclasses <- sort(as.character(unique(pred.dat$ar50artype)))
artable.tr <- matrix(NA,nrow=length(species),ncol=length(arclasses))
rownames(artable.tr) <- species
colnames(artable.tr) <- c("Developed","Agricultural","Forest","Barren","Mire","Glacier","Freshwater","Marine","Unmapped")
#colnames(artable.tr) <- arclasses
artable.tr.sd <- artable.tr
for(i in 1:length(species))
{
  tr <- values(trend[[i]]*mcras[[i]])
  tr.by.ar <- tapply(tr,pred.dat$ar50artype,mean,na.rm=T)
  artable.tr[i,match(names(tr.by.ar),arclasses)] <- tr.by.ar
  tr.by.ar.sd <- tapply(tr,pred.dat$ar50artype,sd,na.rm=T)
  artable.tr.sd[i,match(names(tr.by.ar.sd),arclasses)] <- tr.by.ar.sd
}
artable.tr <- 100*artable.tr # Expressing results in percent
artable.tr.sd <- 100*artable.tr.sd # Expressing results in percent

kable(round(artable.tr[,1:8],2),format="markdown",caption="Table 3. Change from 1950 to 2019 in the predicted frequency (expressed as difference in percentage points) of the species in 1km by 1km cells with a given dominant land cover type within the minimum convex polygon covering 99% of the observations of the species (NaN means that the species is not observed in the land cover class).")
# kable(round(artable.tr.sd/artable.tr,2),"markdown",caption="Table 3. Change from 1950 to 2019 in the predicted frequency (percentage points) of the species in 1km by 1km cells with a given dominant land cover type.")

```


```{r echo=FALSE, fig.width=8, fig.height=8}
# # Plots for all species
# pdf("scatterplots.pdf")
# for(i in 1:length(species))
# {
#   par(mfrow=c(2,2))
#   tr <- values(trend[[i]]*mcras[[i]])
#   scatter.smooth(pred.dat$Growingseasonlength,tr,pch=".",col=gray(0.8,alpha=0.5),xlab="Growing season length (days)",main=species[i],lpars=list(col="red"))
#   scatter.smooth(pred.dat$bioclim12,tr,pch=".",col=gray(0.8,alpha=0.5),xlab="Annual precipitation (mm)",main=species[i],lpars=list(col="red"))
#   scatter.smooth(pred.dat$TopographicWetnessIndex,tr,pch=".",col=gray(0.8,alpha=0.5),xlab="Topographic wetness index",main=species[i],lpars=list(col="red"))
#   scatter.smooth(pred.dat$swe5,tr,pch=".",col=gray(0.8,alpha=0.5),xlab="Snow water equivalent in May (mm)",main=species[i],lpars=list(col="red"))
#   }
# dev.off()

# Selected plots
par(mfrow=c(2,2))
# Growing season length: Arnica montana
i <- 11
tr <- values(trend[[i]]*mcras[[i]])
dat <- data.frame(pred.dat,tr=tr)
dat <- dat[complete.cases(dat),]
scatter.smooth(dat$Growingseasonlength,dat$tr,pch=".",col=gray(0.6,alpha=0.5),xlab="Growing season length (days)",ylab="Trend",main=species[i],lpars=list(col="red"))
#text(c(250,0.009),labels="A")
#text(c(0.9*max(dat$Growingseasonlength),0.9*max(dat$tr)),labels="A")
#text("topright","A")

# Total annual precipitation: Primula vulgaris
i <- 5
tr <- values(trend[[i]]*mcras[[i]])
scatter.smooth(pred.dat$bioclim12,tr,pch=".",col=gray(0.6,alpha=0.5),xlab="Annual precipitation (mm)",ylab="Trend",main=species[i],lpars=list(col="red"))
#text("topright","B")

# Topographic wetness index: Thelypteris palustris
i <- 6
tr <- values(trend[[i]]*mcras[[i]])
scatter.smooth(pred.dat$TopographicWetnessIndex,tr,pch=".",col=gray(0.6,alpha=0.5),xlab="Topographic wetness index",ylab="Trend",main=species[i],lpars=list(col="red"))
#text("topright","C")

# Snow water equivalent: Ulmus glabra
i <- 1
tr <- values(trend[[i]]*mcras[[i]])
scatter.smooth(pred.dat$swe5,tr,pch=".",col=gray(0.6,alpha=0.5),xlab="Snow water equivalent in May (mm)",ylab="Trend",main=species[i],lpars=list(col="red"))
#text(c(0.95*max(pred.dat$swe5,na.rm=T),0.95*max(tr,na.rm=T)),labels="D")

```
  
_Figure 3. Trends for selected indicator species (difference in predicted frequency between 1950 and 2019) in relation to selected climate-related variables._
  
  
The trends of some species may be related to different aspects of climate (Figure 3), which varies more systematically than land cover on broad geographical scales. Several species have higher trends in areas with short growing seasons within their distributions (_Ulmus glabra_, _Leucanthemum vulgare_, _Thelypteris palustris_, _Rhyncospora alba_, _Drosera intermedia_ and _Arnica montana_, i.e. areas towards the north or higher elevations. This may indicate a climate-driven change in distribution: northern areas are known to warm faster ("Arctic amplification"), potentially allowing the species to expand northwards as growing conditions improve. The lower, and sometimes negative, trends in warmer areas may be due to increased competition from other native or introduced species (suspected for e.g. _Ulmus glabra_; Henriksen and Hilmo 2015), but also changing land use in the south, such as increased intensification of agricultural areas and regrowth of marginal areas (e.g. for _Arnica montana_). There are also examples of species with tendencies to more positive trends in areas with longer growing seasons (_Papaver radicatum_, _Primula vulgaris_).
  
For most species there was no clear variation in trend with total annual precipitation alone, but there are a few examples of contrasting trends that seem to be related to the geographical distribution of the species. For example, among the open lowland indicators the predominantly oceanic species _Erica cinerea_ and _Primula vulgaris_ show increasing trends with total annual precipitation (Figure 3), while other species with broader and more continental distributions, show less positive (_Laucanthemum vulgare_) or even negative trends (_Arnica montana_) with higher precipitation. Among the wetland indicators, the two widespread Carex species seem to respond in opposite ways: _Carex pauciflora_ shows lower trends with higher precipitation, while (the slightly more continental) _Carex vesicaria_ shows higher (less negative) trends with higher precipitation. These mixed results suggest that other aspects of water than total precipitation may be important, such as ground-related hydrology. For _Thelypteris palustris_ we see that in areas with a high topographic wetness index, the trends have been less negative than in areas in drier parts of the landscape (Figure 3). With a finer spatial resolution, these patterns may have been even clearer, perhaps for other wetland species as well. Finally, for a few species with generally positive trends (_Leucanthemum vulgare_ and _Ulmus glabra_), high snow cover in May seems to reduce the positive trends (Figure 3), suggesting that snow cover may limit the growing season and thus hamper the expansion of these species in snow-rich areas.


```{r echo=FALSE, fig.width=8, fig.height=12}
# Trends in relation to nitrogen deposition
N.poly <- readOGR(dsn="Data/Shapefiles",layer="Sdep_Ndep_-_gjennomsnitt_pr_kommune",verbose=FALSE,encoding="")
Ndep <- rowMeans(data.frame(N.poly[,10:15])) # Mean annual deposition 1950-2011

if(!exists("tr.avg"))
{
  # Average trends per municipality for all species
  tr.avg <- list()
  for(i in 1:length(species))
  {
    tr <- trend[[i]]*mcras[[i]]
    tr.avg[[i]] <- extract(tr,N.poly,fun=mean,na.rm=T)
  }
}

# # Plots for all species
# pdf("N scatterplots.pdf")
# for(i in 1:length(species))
# {
#   if(all(is.na(tr.avg[[i]]))) next
#   scatter.smooth(Ndep,tr.avg[[i]],col=gray(0.2,alpha=0.5),xlab="Mean N deposition",ylab="Mean trend",main=species[i],lpars=list(col="red"))
# }
# dev.off()

# Selected plots
par(mfrow=c(3,2))
for(i in c(3,8,11,12,14,17))
{
  scatter.smooth(Ndep,tr.avg[[i]],col=gray(0.2,alpha=0.5),xlab="Mean N deposition",ylab="Mean trend",main=species[i],lpars=list(col="red"))
}

```

_Figure 4. Mean trends per municipality 1950-2019 for selected species in relation to mean annual nitrogen deposition 1950-2011._
  
  
Several of the indicator species appear to have very clear negative relationships to patterns in nitrogen deposition (Figure 4). This may suggest that nitrogen has a strong effect on many of the species, possibly through competitive interactions. However, it is not perfectly clear that the observed patterns are in fact due to nutrient enrichment. In Norway, nitrogen deposition is strongly related to climatic patterns. Deposition is highest in the southwest, where the climate is warmest and wettest. As a consequence, relationships between species trends and N deposition patterns may resemble relationships between trends and climate variables (depending on the distribution of the species). In fact, all of the patterns plotted in Figure 4 to some degree resemble the patterns for total annual precipitation (although the patterns for precipitation appear less clear due to the much higher spatial resolution). Moreover, because of the relationship between N deposition and beneficial climate, N deposition may also be confounded with high land-use intensity in agricultural and (semi-)urban areas. The low trends for _Leuchantemum vulgare_ and the negative trends for _Arnica montana_ at high N deposition levels may be due to stronger land-use intensification in highly productive agricultural regions, as well as abandonment of less productive lands in the same regions.

In conclusion, although the effects of pressures have not been formally tested statistically, there are indications in the model results of negative effects of various pressures on several of the species (Table 4). For some species, this study finds few indications of expected effects, such as climatic effects on the alpine species _Ranunculus glacialis_ and land use effects on the open lowland species _Primula vulgaris_. However, many of the indicated effects are in line with expectations.
  
  
```{r echo=FALSE}
# Table of pressures causing negative development (in at least some areas) for
# the indicator species
# NB! This is manually constructed on the basis of interpretation of results above
# and must be edited when the results change
prtable <- matrix(" ",nrow=length(species),ncol=3)
rownames(prtable) <- species
colnames(prtable) <- c("Land use","Climate","Pollution")
prtable["Papaver radicatum",]     <- c(" " ,"T/S"," " )
prtable["Kalmia procumbens",]     <- c(" " ," " ,"N")
prtable["Thelypteris palustris",] <- c("D","T"," " )
prtable["Moneses uniflora",]      <- c("I"," " ,"N")
prtable["Leucanthemum vulgare",]  <- c("I","T/P","N")
prtable["Carex vesicaria",]       <- c("D"," " ," " )
prtable["Arnica montana",]        <- c("I","T/P","N")
prtable["Carex pauciflora",]      <- c("I","T/P","N")
prtable["Rhynchospora alba",]     <- c("I","T/P","N")
prtable["Rhynchospora fusca",]    <- c(" " ," " ,"N")
prtable["Drosera intermedia",]    <- c(" " ,"T","N")

kable(prtable,format="markdown",align='c',caption="Table 4. Overview of pressures that may affect indicator species negatively, as suggested by expert interpretation (not statistical tests) of the results of this study. Land use: drainage (D), intensification of agriculture/forestry (I). Climate: increased temperature/growing season (T), increased precipitation (P), reduced snow cover (S). Pollution: nitrogen deposition (N).")

```

# 5. Perspectives and conclusions
The current analyses have produced more precise estimates of indicator states than previous methods. The analyses have also revealed some new patterns, as discussed above. We should of course beware that with such noisy data, we run the risk of identifying patterns in the noise rather than in the signal. The uneven sampling in space and time, with lower sampling in remote areas and early years, is particularly challenging. To reduce sensitivity to sampling bias, the models were deliberately made smoother than default (gamma=3) for all species. This reduces the risk of detecting false trends, but at the same time may hide real trends for some species.

One opportunity to obtain more information from the data could be to fine-tune the GAMs for each species individually. Adding elevation may improve predictions for several species, but given the coarse spatial resolution of the NI, where predictions are averaged across municipalities with large elevation ranges, it is not clear that this added complexity is worthwhile. Another possibility is further data treatment, such as other resolution in space and time and separate treatment of different data types (e.g. single observations, checklist data, systematic data), although some data types (e.g. checklists) are only available in recent times.

There are several alternative approaches for modelling population states and trends, and as computing power develops, increasingly complex modelling of high-resolution observation and population processes at high resolution (e.g. Wikle & Hooten 2010) will be feasible for many species. A key issue for further progress is improved representation of observation processes. Appropriate modelling of the different kinds of observation practices (corresponding to the different data types above), will most likely also improve the underlying population process models. 


## Conclusions
The analyses above suggest that GBIF data largely represent NI vascular plant indicators in the right environment. The models produce sensible patterns, both in terms of the geographical distributions of species, and in terms of temporal trends and spatial variation in trends, and current methods produce more precise estimates than previous methods. The assessment of estimated trends and pressures suggest realistic relationships between species trends and relevant pressures.  

These results come with some warnings. There is substantial unexplained variation for all species, which may be related to the representation and separation of process variation and observation error as well as a lack of high-quality representation of covariates. Some presumptive patterns within the range of the data may be caused by observation error, and predictions (far) outside the range of observations should be interpreted with great caution. Finally, based on the current analysis it may be difficult to interpret pressures independently. For instance, land use is related to temperature (e.g. growing season) and N deposition is related to both climate and land use. To address these challenges, we will need higher resolution, local observational studies and experiments. The present data and analyses nevertheless produced results that should be of some value in building and interpreting a high-level biodiversity indicator like the Nature Index.  



# References
Henriksen S. and Hilmo O. (eds.) 2015. Norwegian red list for species 2015. Norwegian Biodiversity Information Centre.  
Horvath P., Halvorsen R., Stordal F., Tallaksen L.M., Tang H. and Bryn A. 2019. Distribution modelling of vegetation types based on area frame survey data. Applied Vegetation Science 22(4):547-560.
Lund E., Aas W., Høgåsen T. and Larssen T. 2012. Overskridelser av tålegrenser for forsuring og nitrogen for Norge–oppdatering med perioden 2007–2011. NIVA-rapport 6448-2012.
Wikle C.K. 2003. Hierarchical models for predicting the spread of ecological processes. Ecology 84:1382-1394.
Wikle C.K. and Hooten M. 2010. A general science-based framework for dynamical spatio-temporal models. Test 19:417-451.
Wood S.N. 2017. Generalized additive models: an introduction with R. CRC press.  


# Appendix 1: R code for indicator estimation
```{r eval=FALSE}
# Script for estimation of indicator values and references states for 17 vascular plants
# for the Nature Index 2020

######################################
# Tools
######################################

# NIcalc pacakge for reading/writing to NI database
install.packages(pkgs = 
                   "https://github.com/NINAnor/NIcalc/releases/download/0.0.1.2/NIcalc_0.0.1.2.zip", 
                 repos = NULL)

# Other libraries needed:
# rgbif, rgdal, sp, raster, rio, mgcv


#################################################
# Data download and preparation
#################################################


### Indicator species names
art <- c("alm","fjellvalmue","greplyng","issoleie","kusymre","myrtelg","olavsstake","prestekrage",
         "purpurlyng","sennegras","solblom","sveltstarr","engmarihand","hvitmyrak","brunmyrak","smalsoldogg","dikesoldogg")
species <- c("Ulmus glabra","Papaver radicatum","Kalmia procumbens","Ranunculus glacialis","Primula vulgaris",
             "Thelypteris palustris","Moneses uniflora","Leucanthemum vulgare","Erica cinerea","Carex vesicaria",
             "Arnica montana","Carex pauciflora","Dactylorhiza incarnata","Rhynchospora alba","Rhynchospora fusca",
             "Drosera anglica","Drosera intermedia")


### Retreive and store old data from NI database
library(NIcalc)
NIcalc::getToken(username=myUserName,  # Specify your user name
                 password=myPassword,  # Specify your password
                 url="https://www8.nina.no/NaturindeksNiCalc")source('species.r')
myIndicators <- NIcalc::getIndicators() 
myIndicators <- myIndicators[myIndicators$id!=3,]  # removing one indicator which is estimated with other data and methods (3: Alge på bjørk)
myIndicators <- cbind(myIndicators,species=species)
oldIndicatorData <- list()
for(i in 1:length(species))
{
  oldIndicatorData[[i]] <- NIcalc::getIndicatorValues( indicatorID = myIndicators$id[i]) 
}
names(oldIndicatorData) <- myIndicators$name
save(oldIndicatorData,file="oldIndicatorData")


### Download occurrence data from GBIF
# This part is based on the extensively commented instructions for
# asynchronous downloading of GBIF data by Anders Finstad, available here:
# https://gbif-europe.github.io/nordic_oikos_2018_r/s3_gbif_demo/3.x_async_download_gbif.Rmd
# This allows downloading larger data sets, and citation of the download with a single doi. 

# Libraries
library(rgbif)
library(rio)
library(sp)
library(raster)

# Set up a user profile at GBIF (https://www.gbif.org), then
# run this once to store your GBIF user credentials to your R session 
options(gbif_user=rstudioapi::askForPassword("my gbif username"))
options(gbif_email=rstudioapi::askForPassword("my registred gbif e-mail"))
options(gbif_pwd=rstudioapi::askForPassword("my gbif password"))

# Download all vascular plants
# Find a taxonkey - get list of gbif keys to filter download
key <- name_suggest(q='Plantae', rank='kingdom')$key[1] 

# Get download key for all occurrences of plants with coordinates in Norway
download_key <- 
  occ_download(
    paste('taxonKey',key,sep=" = "),
    'hasCoordinate = TRUE',
    "country = NO",
    type = "and"
  ) %>% 
  occ_download_meta

# Download data
path <- "C:/Users/oskarpaa/Documents/R/R/NI 2020"
occ_download_get(key=download_key$key,path=path)

# Citation - copy into documentation
paste("GBIF Occurrence Download", download_key[2], "accessed via GBIF.org on", Sys.Date())

# Open data and extract into data frame
# Get a list of the files within the archive by using "list=TRUE" in the unzip function
download_path <- paste(path,"/",download_key$key,".zip",sep="")
archive_files <- unzip(download_path, files = "NULL", list = T) 
archive_files

# # Get the occurrence.txt file in as a dataframe (using import from rio)
# sp <- import(unzip(download_path,files="occurrence.txt"),header=T,sep="\t")
# dim(sp)

# Data import from downloaded occurrence file
sp <- import("occurrence.txt") #,header=T,sep="\t")
dim(sp)
head(sp)

# Select fields
# Only species, geographical coordinates (with uncertainty/precision) and time (year, month, day) are
# needed for the modelling, but other fields may be useful for error checking etc.
selectedFields <- c( "institutionID","collectionID","catalogNumber",
                     "basisOfRecord","contributor",
                     "species","scientificName","taxonID","taxonKey",
                     "year","month","day",
                     "countryCode","county","municipality",
                     "decimalLongitude","decimalLatitude","coordinateUncertaintyInMeters","coordinatePrecision") 
sp <- sp[,selectedFields]
dim(sp)

# Remove obs with missing dates and/or coordinates (shouldn't be necessary when "has coordinate"=TRUE, but quite a few long and lat are missing...)
sp <- sp[complete.cases(sp[,c("year","month","day","decimalLongitude","decimalLatitude")]),]
dim(sp)

# Convert lat-long coordinates to coordinate system of Norway raster
occ_points <- data.frame(x=sp$decimalLongitude,y=sp$decimalLatitude)
occ_points <- SpatialPoints(occ_points,proj4string=CRS("+proj=longlat +datum=WGS84"))
occ_UTM33 <- spTransform(occ_points,CRS("+proj=utm +zone=33 ellps=GRS80 +units=m"))
sp$x <- occ_UTM33$x
sp$y <- occ_UTM33$y

# Creating a spatial points data frame, and adding unique date (better than eventDate, which may be misleading if occurrences with month only are recorded on the first day)
#load("occurrences cleaned") # for high-precision data
occ_UTM33 <- SpatialPointsDataFrame(data.frame(x=sp$x,y=sp$y),data=data.frame(sp))
occ_UTM33$year_month_day <- paste(occ_UTM33$year,occ_UTM33$month,occ_UTM33$day)



### Rasterize occurrence data

library(raster)

# Set time intervals
start.year <- seq(1820,2015,by=5) # 5-year intervals from 1820 to 2020

# Rasterize sampling effort in time intervals
norway <- raster("Data/Raster/Norway.tif")  # Background raster of Norway (all values = 1)
samp_ras <- stack(norway)
for(i in 1:length(start.year))
{
  print(start.year[i])
  records.in.interval <- (occ_UTM33$year >= start.year[i]) & (occ_UTM33$year < start.year[i]+5)
  print(table(records.in.interval))
  if(!any(records.in.interval)) samp_ras[[i]] <- norway*0
  else samp_ras[[i]] <- norway*rasterize(occ_UTM33[records.in.interval,],norway,field="year_month_day",fun=function(x,...){length(unique(x))},background=0) # raster with counts of sampling effort in each cell of norway
}
names(samp_ras) <- paste("t",start.year,sep=".")
save(samp_ras,file="Data/Raster/samp_ras_all")  # unfiltered data

# Rasterize species records in time intervals
source("species.r")
occ_ras_list <- list()
#occ_species_list <- list()
for(j in 1:length(species))
{
  key <- name_suggest(q=species[j], rank='species')$key
  occ_species <- occ_UTM33[occ_UTM33$taxonKey%in%key,]
  cat(species[j],nrow(occ_species),"\n")
#  occ_species_list[[j]] <- occ_species
  occ_ras_list[[j]] <- stack(norway)
  for(i in 1:length(start.year))
  {
    records.in.interval <- (occ_species$year >= start.year[i]) & (occ_species$year < start.year[i]+5)
    cat(start.year[i],sum(records.in.interval),"\n")
    if(!any(records.in.interval)) occ_ras_list[[j]][[i]] <- norway*0
    else occ_ras_list[[j]][[i]] <- norway*rasterize(occ_species[records.in.interval,],norway,field="year_month_day",fun=function(x,...){length(unique(x))},background=0) # raster with counts of occurrences in each cell of norway
  }
  names(occ_ras_list[[j]]) <- paste("t",start.year,sep=".")
}
names(occ_ras_list) <- species
save(occ_ras_list,file="Data/Raster/occ_ras_list_all") # unfiltered data


# Build training data sets for distribution modelling with
# all data (no filter on precision), for all times with continuous sampling (1820 onwards)
load("Data/Raster/occ_ras_list_all")  # unfiltered data
load("Data/Raster/samp_ras_all")      # unfiltered data
year <- seq(1820,2015,by=5)
yr <- paste("t.",year,sep="")
for(j in 1:length(species))
{
  cat(species[j],"\n")
  for(k in 1:length(year))
  {
    cat(year[k],"\n")
    
    # Extract occurrence and sampling rasters
    o_ras <- occ_ras_list[[j]][[yr[k]]]
    s_ras <- samp_ras[[yr[k]]]
    
    # Take the occurrence cells as presences
    presences <- which(values(o_ras)>0)
    
    # Take cells with sampling events of some species
    # but without occurrence observations of this particular species
    absences <- which((values(s_ras)>0) & (values(o_ras)==0))
    
    # # Sample absences if too many?
    # absences_sample <- sample(absences,size=length(presences)) # sample of same number of absence cells as presence cells
    
    # Combine presences, absences and environmental data
    selected <- c(presences,absences)
    #selected <- c(presences,absences_sample)
    xy <- raster::coordinates(o_ras)[selected, ]
    data <- data.frame(xy,Y=values(o_ras)[selected],logS=log(values(s_ras)[selected]),
                       year=rep(year[k],nrow(xy)))
    # presence <- as.numeric(data$Y>0)
    # data <- cbind(presence,data)   # MIAmaxent wants presence as the first column
    
    if(k==1) training_data <- data
    else training_data <- rbind(training_data,data)
  }
  # # Convert discrete environmental predictors to factor variables
  # training_data$ar50artype <- factor(training_data$ar50artype)
  # training_data$geonorge123 <- factor(training_data$geonorge123)
  
  # Save training data
  save(training_data,file=paste("Data/Regression data/",species[j],"_training_data_all",sep=""))
}



################################################
# Modelling
################################################
# GAM spacetime model with geographic coordinates (x and y in meters), year (5-year intervals) and interactions (x:year and y:year).
# Sampling effort as offset. No environmental covariates.

# GAM: all data (no spatial precision filtering) and smoothing parameter gamma=3
library(mgcv)
gam.results <- list()
for(j in 1:length(species))
{
  cat(species[j],"\n")
  
  # Training data for species from GBIF, see NI 2020 plants dataprep.r
  load(paste("Data/Regression data/",species[j],"_training_data_all",sep=""))
  d <- training_data[,c("Y","x","y","year","logS")]
  m <- gam(Y~ti(x)+ti(y)+ti(year)+ti(x,year)+ti(y,year),
           data=d,gamma=3,family=poisson,offset=logS,select=TRUE)
  gam.results[[j]] <- m
}
save(gam.results,file="Results/gam.results.all.gamma3")



################################################
# Prediction: NI indicator value estimation
################################################

# GAM predictions: municipality maps for specific NI years
library(rgdal)
kommune.poly <- readOGR(dsn="Data/Shapefiles",layer="Norway municipalities",encoding="")
year <- c(1900,1950,1990,2000,2010,2014,2019)
xy <- coordinates(norway)
x <- y <- norway
values(x) <- xy[,1]
values(y) <- xy[,2]
NIGAM_All.list <- list()
pdf("GAMplotsMunicAll.pdf")
# load("Results/gam.results.all.gamma3")  # Uncomment to load results from previous steps, if entire script is not run continuously
for(j in 1:length(species))
{
  print(species[j])
  NIGAM_All.list[[j]] <- list()
  for(i in 1:length(year))
  {
    print(year[i])
    pred.ras <- stack(year[i]*norway,x,y,log(norway))
    names(pred.ras)[1:5] <- c("year","x","y","logS")
    pred.dat <- as.data.frame(values(pred.ras))
    p <- norway
    pred <- predict(gam.results[[j]],pred.dat,se.fit=TRUE,type="response") # The ordinary raster prediction does not always work: p <- predict(pred.ras,glm.results[[j]],type="response")
    values(p) <- as.vector(pred$fit)
    p.poly <- extract(p,kommune.poly,sp=TRUE,fun=mean,na.rm=T,weights=TRUE,normalizeWeights=TRUE)
    b <- seq(0,0.1,by=0.001)
    n <- length(b)
    plot(p.poly,col=rev(terrain.colors(n-1))[cut(p.poly$layer,breaks=b)],main=paste(species[j],year[i]))
    values(p) <- as.vector(pred$se.fit)
    p.poly.se <- extract(p,kommune.poly,sp=TRUE,fun=mean,na.rm=T,weights=TRUE,normalizeWeights=TRUE)
    NIGAM_All.list[[j]][[i]] <- list(p=p.poly,p.se=p.poly.se)
  }
}
dev.off()
names(NIGAM_All.list) <- species

# Build data frame with new NI indicator values (GAM predictions per municipality)
#load("oldIndicatorData") # Uncomment to load results from previous steps, if entire script is not run continuously
newIndicatorData <- oldIndicatorData
for(j in 1:length(species))
{
  print(species[j])
  
  # Make data objects of old and new indicator sets for further manipulation
  old <- oldIndicatorData[[j]]$indicatorValues
  new <- newIndicatorData[[j]]$indicatorValues

  selected.year <- old$yearName=="Referanseverdi"
  oldref <- old[selected.year,]
  old$ref <- oldref$verdi[match(old$areaName,oldref$areaName)]

  newref.poly <- NIGAM_All.list[[j]][[1]]$p
  newref.se.poly <- NIGAM_All.list[[j]][[1]]$p.se
  r <- match(newref.poly$NAVN,oldref$areaName)
  new$verdi <- NA
  new$verdi[selected.year][r[!is.na(r)]] <- newref.poly$layer[!is.na(r)]
  new$verdiSE <- NA
  new$verdiSE[selected.year][r[!is.na(r)]] <- newref.se.poly$layer[!is.na(r)]
  newref <- new[new$yearName=="Referanseverdi",]
  new$ref <- newref$verdi[match(new$areaName,newref$areaName)]
  for(i in 2:(length(year)-1))
  {
    selected.year <- old$yearName==as.character(year[i])
    oldval <- old[selected.year,]
    newval <- NIGAM_All.list[[j]][[i]]$p
    newval.se <- NIGAM_All.list[[j]][[i]]$p.se
    o <- match(newval$NAVN,oldval$areaName)
    new$verdi[selected.year][o[!is.na(o)]] <- newval$layer[!is.na(o)]
    new$verdiSE[selected.year][o[!is.na(o)]] <- newval.se$layer[!is.na(o)]
  }
  def <- old$ref/old$ref # indicator value for definition area (1) or not (NA) - used to remove new predictions outside definition area in next three lines
  new$ref <- new$ref*def
  new$verdi <- new$verdi*def
  new$verdiSE <- new$verdiSE*def
  newIndicatorData[[j]]$indicatorValues <- new
}

# Create distribution objects and format data for import to NI base (based on code from NIcalc vignette)
library(NIcalc)
updatedIndicatorData <- oldIndicatorData
for(j in 1:length(species))
{
  print(species[j])

  # Create distributions
  d <- newIndicatorData[[j]]$indicatorValues
  myData <- data.frame(estimatedStates = d$verdi,
                       standardErrors = d$verdiSE)
  logNormalParams <- NIcalc::normal2Lognormal(mean = myData$estimatedStates, 
                                              sd = myData$standardErrors)
  myData$muLogNormal <- logNormalParams$mean 
  myData$sigmaLogNormal <- logNormalParams$sd
  
  ddd <- NULL
  for (i in 1:dim(myData)[[1]])
  {
    if(any(is.na(myData[i,c("muLogNormal","sigmaLogNormal")]))) {ddd[i] <- NA; next}
    ddd[i] <- list(NIcalc::makeDistribution(
      input = "logNormal",
      distParams = list(mean = myData$muLogNormal[i],
                        sd = myData$sigmaLogNormal[i]))) 
  }
  myData$distrObjects <- ddd
  myData$areaIDs <- d$areaId
  myData$years <- d$yearName
  myData$Datatype <- d$datatypeId
  
  rowsWithNAs <- which(is.na(myData$estimatedStates))
  rowsWithoutNAs <- which(!is.na(myData$estimatedStates))
  if(any(rowsWithNAs))
  {
    for(i in rowsWithNAs)
    {
      updatedIndicatorData[[j]] <- NIcalc::setIndicatorValues(updatedIndicatorData[[j]],
                                                              areaId = myData$areaIDs[i],
                                                              years = myData$years[i],
                                                              est = myData$estimatedStates[i],
                                                              lower = myData$estimatedStates[i]-myData$standardErrors[i],
                                                              upper = myData$estimatedStates[i]+myData$standardErrors[i])
    }
  }
  for(i in rowsWithoutNAs)
  {
    updatedIndicatorData[[j]] <- NIcalc::setIndicatorValues(updatedIndicatorData[[j]], 
                                                       areaId = myData$areaIDs[i], 
                                                       years = myData$years[i], 
                                                       distribution = myData$distrObjects[[i]],
                                                       datatype = myData$Datatype[i])
  } 
}

# Write updated indicator data to NI database
# (unitOfMeasurement needs to be updated manually. New units: "Funnsannsynlighet i 1x1km-ruter")
# Get token for writing to NI database if script is not run continuously (see above).
# Code below commented to avoid accidential overwriting of data in the NI database.
# Uncomment to write to database:
# for(j in 1:length(species))
# {
#   print(species[j])
#   NIcalc::writeIndicatorValues(updatedIndicatorData[[j]])
# }

# Check uploaded data by downloading the same data sets
for(j in 1:length(species))
{
  print(species[j])
  d1 <- updatedIndicatorData[[j]]$indicatorValues
  indicatorData <- NIcalc::getIndicatorValues(indicatorID = myIndicators$id[myIndicators$species==species[j]]) 
  d2 <- indicatorData$indicatorValues
  print(head(d1))
  print(head(d2))
  check_all <- data.frame(d1$verdi,d2$verdi)
  check_all$check <- check_all[,1]/check_all[,2]
  print("Check all = 1")
  print(summary(check_all$check))
}

```

# Appendix 2: Summaries of GAMs
```{r echo=TRUE}
names(gam.results) <- species
lapply(gam.results,summary)
```
